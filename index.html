<!doctype html>
<html lang="en">
	<head>
		<title>Nykaa Virtual Makeup Demo</title>
		<meta charset="utf-8">
		<style>
			#overlay {
				position: absolute;
				top: 0px;
				left: 0px;
			}

			#container {
				position : relative;
				width : 700px;
				height : 500px;
				/*margin : 0px auto;*/
			}

			#content {
				/*margin-top : 70px;*/
				margin-left : 100px;
				margin-right : 100px;
				max-width: 950px;
			}

			#convergence {
				display : inline;
			}

			h2 {
				font-weight : 400;
				font-family: 'helvetica';
			}

			.btn {
				font-family: 'Lato';
				font-size: 16px;
			}

			.hide {
				display : none;
			}
		</style>
		
	</head>
	<body>
		<script src="/static/src/utils.js"></script>
		<script src="/static/src/dat.gui.min.js"></script>
		<script src="/static/src/jquery.min.js"></script>
		<script src="/static/src/clmtrackr.no_model.js"></script>
		<!-- <script src="/static/src/models/model_spca_20_svm.js"></script> -->
		<script src="/static/src/models/model_pca_20_svm.js"></script>
		<!-- <script src="/static/src/models/model_svm.js"></script> -->
		<!-- <script src="/static/src/models/model_pca_20_mosse.js"></script> -->
		<!-- <script src="/static/src/models/model_mosse.js"></script> -->
		<!-- <script src="/static/src/model_builder/model_mosse.js"></script> -->
		<div id="content">
			<!-- <img src="static/images/Nykaa-logo.png" width="100px;" /> -->
			<img src="static/images/tangent.jpg" width="210px;" />
			<h2>your personal stylist</h2>
			<div id="container">
				<canvas id="image" width="625" height="500"></canvas>
				<canvas id="overlay" width="625" height="500"></canvas>
			</div>
			<br/>
			<input type="button" class="btn" value="start" onclick="animateClean()"></input>
			<input type="file" class="btn" id="files" name="files[]" />
			<p id="convergence"></p>
			<script>
				var cc = document.getElementById('image').getContext('2d');
				var overlay = document.getElementById('overlay');
				var overlayCC = overlay.getContext('2d');
				var currentPos;
				//https://www.auduno.com/clmtrackr/docs/reference.html
				var UpperlipPtsIndex = [44,45,46,47,48,49,50,59,60,61]
				var LowerlipPtsIndex = [44,56,57,58,50,51,52,53,54,55]
				var UpperlipUpperPts = [44,45,46,47,48,49,50]
				var UpperlipLowerPts = [50,59,60,61,44]
				var LowerlipUpperPts = [44,56,57,58,50]
				var LowerlipLowerPts = [50,51,52,53,54,55,44]
				//https://www.pyimagesearch.com/wp-content/uploads/2017/04/facial_landmarks_68markup.jpg
				var currentPos_dlib
				var UpperlipUpperPts_dlib = [48,49,50,51,52,53,54]
				var UpperlipLowerPts_dlib = [54,64,63,62,61,60,48]
				var LowerlipUpperPts_dlib = [48,67,66,65,54]
				var LowerlipLowerPts_dlib = [54,55,56,57,58,59,48]
				var lipColor = '#800000';
				var ctrack = new clm.tracker({stopOnConvergence : true});
				ctrack.init(pModel);	//the pModel would get created via model file. this could be this.pModel as well.

				var drawRequest;

				function animateClean() {
					ctrack.start(document.getElementById('image'));
					drawLoop();
				}

				function animate(box) {
					ctrack.start(document.getElementById('image'), box);
					drawLoop();
				}

				function drawLoop() {
					drawRequest = requestAnimFrame(drawLoop);
					overlayCC.clearRect(0, 0, 720, 576);
					if (ctrack.getCurrentPosition()) {
						currentPos =ctrack.getCurrentPosition() ;
						// console.log(ctrack.getCurrentParameters());
						// console.log(ctrack.getScore());
						// ctrack.draw(overlay);
					}
				}
				//lipUpperPts, lipLowerPts

				function drawArc(ctx, p1, p2, p3){
					var controlX=2*p2[0]-p1[0]/2-p3[0]/2;
					var controlY=2*p2[1]-p1[1]/2-p3[1]/2;
					ctx.quadraticCurveTo(controlX,controlY,p3[0],p3[1]);
				}

				function drawLipCurves(u, l, pts){
					var ctx = document.getElementById('overlay').getContext('2d');
					ctx.strokeStyle = lipColor;
					ctx.beginPath();
					ctx.moveTo(pts[u[0]][0], pts[u[0]][1]);
					for(var i=0; i<u.length-1; i+=2){
						drawArc(ctx, pts[u[i]], pts[u[i+1]], pts[u[i+2]])
					}
					for(var i=0; i<l.length-1; i+=2){
						drawArc(ctx, pts[l[i]], pts[l[i+1]], pts[l[i+2]])
					}
					ctx.closePath();
					ctx.stroke()
				}

				function drawLip(lipPtsIndex) {
					var ctx = document.getElementById('overlay').getContext('2d');
					ctx.fillStyle = lipColor;
					ctx.beginPath();
					var pt = currentPos[lipPtsIndex[0]]
					ctx.moveTo(pt[0], pt[1]);
					for(var i =1; i < lipPtsIndex.length; i++){
						pt = currentPos[lipPtsIndex[i]]
						ctx.lineTo(pt[0], pt[1]);
					}
					ctx.closePath();
					ctx.fill()
					// ctx.stroke();	
				}

				// detect if tracker fails to find a face
				document.addEventListener("clmtrackrNotFound", function(event) {
					ctrack.stop();
					cancelRequestAnimFrame(drawRequest);
					alert("Sorry, No face found. Please select a different image.")
				}, false);

				// detect if tracker loses tracking of face
				document.addEventListener("clmtrackrLost", function(event) {
					ctrack.stop();
					cancelRequestAnimFrame(drawRequest);
					alert("Sorry, unable to find locations of lips. Please select a different image.")
				}, false);

				// detect if tracker has converged
				document.addEventListener("clmtrackrConverged", function(event) {
					document.getElementById('convergence').innerHTML = "MODEL CONVERGED";
					document.getElementById('convergence').style.backgroundColor = "#00FF00";
					// stop drawloop
					cancelRequestAnimFrame(drawRequest);
					// drawLip(UpperlipPtsIndex);
					// drawLip(LowerlipPtsIndex);
					drawLipCurves(UpperlipUpperPts, UpperlipLowerPts, currentPos);
					drawLipCurves(LowerlipUpperPts, LowerlipLowerPts, currentPos);
					// debugger;
				}, false);

				function setImage(img_url) {
					var canvas = document.getElementById('image')
					var cc = canvas.getContext('2d');
					var img = new Image();
					img.onload = function() {
						if (img.height > 500 || img.width > 700) {
							var rel = img.height/img.width;
							var neww = 700;
							var newh = neww*rel;
							if (newh > 500) {
								newh = 500;
								neww = newh/rel;
							}
							canvas.setAttribute('width', neww);
							canvas.setAttribute('height', newh);
							cc.drawImage(img,0,0,neww, newh);
						} else {
							canvas.setAttribute('width', img.width);
							canvas.setAttribute('height', img.height);
							cc.drawImage(img,0,0,img.width, img.height);
						}
					}
					img.src = img_url;
				}

				function send_file(img_data){
					$.ajax({url: "/get64",
				          type: 'POST',
				          data: {filename: "data", data: img_data},
				          success: function(data, status, xhr) {
				          	currentPos_dlib = JSON.parse(data)
				          	draw_lips_dlib();
				          }
				    });
				}

				function draw_lips_dlib(){
					if(currentPos_dlib["success"]){
						drawLipCurves(UpperlipUpperPts_dlib, UpperlipLowerPts_dlib, currentPos_dlib['64_pts'][0]);
						drawLipCurves(LowerlipUpperPts_dlib, LowerlipLowerPts_dlib, currentPos_dlib['64_pts'][0]);
					}
				}

				// function to start showing images
				function loadImage() {
					if (fileList.indexOf(fileIndex) < 0) {
						var reader = new FileReader();
						reader.onload = (function(theFile) {
							return function(e) {
								// check if positions already exist in storage

								// Render thumbnail.

								setImage(e.target.result);
								send_file(e.target.result);
								// img.src = e.target.result;
							};
						})(fileList[fileIndex]);
						reader.readAsDataURL(fileList[fileIndex]);
						overlayCC.clearRect(0, 0, 720, 576);
						document.getElementById('convergence').innerHTML = "";
						ctrack.reset();
					}
				}

				setImage('/static/images/F1.1.png');
				// set up file selector and variables to hold selections
				var fileList, fileIndex;
				if (window.File && window.FileReader && window.FileList) {
					function handleFileSelect(evt) {
						var files = evt.target.files;
						fileList = [];
						for (var i = 0;i < files.length;i++) {
							if (!files[i].type.match('image.*')) {
								continue;
							}
							fileList.push(files[i]);
						}
						if (files.length > 0) {
							fileIndex = 0;
						}
						loadImage();
					}
					document.getElementById('files').addEventListener('change', handleFileSelect, false);
				} else {
					$('#files').addClass("hide");
					$('#loadimagetext').addClass("hide");
				}
			</script>
		</div>
	</body>
</html>
